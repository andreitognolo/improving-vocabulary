<section class="windfury">
	
    <section class="episode">
        <div>
            <div class="episode"></div>

            <div class="sentences"></div>
            <div class="episode-navigation">
                <button type="button" class="previous btn btn-success">Anterior</button>
                <button type="button" class="next btn btn-success">Proxima</button>
            </div>

            <div>
                <button type="button" class="transcription btn btn-primary">Transcription</button>
            </div>
        </div>
	</section>
    
    <section class="sentence">
        {{~it : sentence}}
            <p><strong>{{!sentence.character}}</strong>: {{!sentence.sentence}}</p>
        {{~}}
    </section>
    
	<script>
        (function($, wf){
            $.wf(['template/base.html'], function(base){
                var tPage = wf.doT(".episode");
                var tSentence = wf.doT(".sentence");
                
                function open(){
                    var page = $(tPage())
                    base.open(page);
                    
                    var episodeId = querystring().get('episodeId');

                    function clickNext() {
                        if (!episodeId) {
                            episodeId = 1;
                        }

                        var data = { previousEpisodeId : episodeId };
                         $.iyvc.nextEpisode(data, function(episode){
                             location = location.hash.split('?')[0] + '?episodeId=' + episode.id;
                         });
                    }

                    function clickPrevious() {

                    }

                    function clickTranscription() {
                        location.hash = "#Transcription?id=" + episodeId;
                    }
                    
                    if (!episodeId) {
                        clickNext();
                        return;
                    }
                    
                    var data = {id:episodeId};
                    $.iyvc.findEpisodes(data, function(episodes){
                        var episode = episodes[0];
                        page.find('.episode').html('<img src="img/calvin-hobbes/' + episode.id + '.gif" />');

                        if (episode.sentences) {
                           page.find('.sentences').html(tSentence(episode.sentences));
                        } else {
                            $.warning('Esse episodio ainda nao foi transcrito!', 10000);
                        }

                        page.find('.next').click(clickNext);
                        page.find('.previous').click(clickPrevious);
                        page.find('.transcription').click(clickTranscription);
                    });
                }
                
                wf.def({
                    open : open
                });
            });
        })(jQuery, windfury);
	</script>
</section>